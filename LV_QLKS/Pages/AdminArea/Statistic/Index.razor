@page "/admin/index"
@page "/admin"
@using System.Globalization
@using OfficeOpenXml.Style
@layout Layout_Admin
@inject NavigationManager NavigationManager
@inject IToastService toastService
@inject IJSRuntime JS
@inject DialogService DialogService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

<PageTitle>Thống kê</PageTitle>
<div class="main-content">
                <div class="section__content section__content--p30">
                    <div class="container-fluid">
                        <div class="container-fluid pt-4 px-4">
                            <div class="row g-4">
                                <div class="col-sm-6 col-xl-3">
                                    <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                                        <i class="fa fa-user fa-3x text-primary"></i>
                                        <div class="ms-3">
                                            <p class="mb-2">Tổng số lượng khách hàng</p>
                                            <h5 class="mb-0">@users.Count</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-xl-3">
                                    <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                                        <i class="fa fa-home fa-3x text-primary"></i>
                                        <div class="ms-3">
                                            <p class="mb-2">Tổng số lượng khách sạn</p>
                                            <h5 class="mb-0">@hotels.Count</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-xl-3">
                                    <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                                        <i class="fas fa-calendar-alt fa-3x text-primary"></i>
                                        <div class="ms-3">
                                            <p class="mb-2">Tổng giá trị đơn đặt phòng</p>
                                            <h5 class="mb-0">@hotelService.FormatVND((int)orderroomReceipts.Sum(or=>or.OrderroomTotalprice))</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-xl-3">
                                    <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                                        <i class="fa fa-chart-line fa-3x text-primary"></i>
                                        <div class="ms-3">
                                            <p class="mb-2">Tổng thu nhập từ Website</p>
                                            <h5 class="mb-0">@hotelService.FormatVND((int)valueOfYears.Sum(voy=>voy.value))</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br/>
                        <br/>
                        <RadzenCard>
                            <div class="container">
                                <div class="row">
                                    <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H4" Class="my-4">
                                        Tần suất đặt phòng
                                    </RadzenText>
                                    <div class="col-sm-12 col-lg-6 offset-lg-3 my-5">
                                        <RadzenCard Class="w-100 mb-4" Style="display: flex; align-items: center; gap: 0.5rem" >
                                            <RadzenCheckBox @bind-Value="@showDataLabels" Name="dataLabels"></RadzenCheckBox>
                                            <RadzenLabel Text="Hiện số lượng phòng được đặt" For="dataLabels" />
                                            <RadzenNumeric onkeydown="return false" @bind-Value="@yearRoomValue" Class="w-25" Max="DateTime.Today.Year" Name="year" TValue="int" Change="YearRoomChange"></RadzenNumeric>
                                            <RadzenLabel Visible=monthCheck Text="Chọn năm" For="year" />
                                        </RadzenCard>
                                        @if(dataItems.Count > 0){
                                            <RadzenChart>
                                                <RadzenDonutSeries Data="@dataItems" CategoryProperty="StrName" ValueProperty="Value">
                                                    <ChildContent>
                                                        <RadzenSeriesDataLabels Visible="@showDataLabels" />
                                                    </ChildContent>
                                                    <TitleTemplate>
                                                        <div class="rz-donut-content">
                                                            <div>Năm @yearRoomValue</div> 
                                                        </div>
                                                    </TitleTemplate>
                                                </RadzenDonutSeries>
                                            </RadzenChart>
                                        }
                                        else{
                                            <div>Không có đơn đặt nào trong năm @yearRoomValue</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </RadzenCard>
                        <RadzenCard>
                            <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H4" Class="my-4">
                            Thống kê doanh thu Website
                        </RadzenText>

                            <div class="container">
                                <div class="row">
                                    <div class="col-sm-12 my-5">
                                        <RadzenCard Class="w-100 mb-4" Style="display: flex; align-items: center; gap: 0.5rem" >
                                            <RadzenCheckBox @bind-Value="@showDataLabels" Name="dataLabels"></RadzenCheckBox>
                                            <RadzenLabel Text="Hiện giá tiền" For="dataLabels" />
                                            <RadzenDropDown AllowClear="true" TValue="int" Class="w-25" Data=@(chooses) TextProperty="name" ValueProperty="value" Change=@(args => OnChange(args)) />
                                            <RadzenButton Text="Export" Icon="get_app" Click="ExportStatistic"></RadzenButton>
                                            <RadzenNumeric onkeydown="return false" Visible=monthCheck @bind-Value="@monthValue" Class="w-25" Min="1" Max="12" Name="month" TValue="int" Change="MonthChange"></RadzenNumeric>
                                            <RadzenLabel Visible=monthCheck Text="Chọn tháng" For="month" />
                                            <RadzenNumeric onkeydown="return false" Visible=monthCheck @bind-Value="@yearValue" Class="w-25" Max="DateTime.Today.Year" Name="year" TValue="int" Change="YearChange"></RadzenNumeric>
                                            <RadzenLabel Visible=monthCheck Text="Chọn năm" For="year" />
                                            <RadzenNumeric onkeydown="return false" Visible=quarterCheck @bind-Value="@yearValue" Class="w-25" Max="DateTime.Today.Year" Name="year" TValue="int" Change="YearChange"></RadzenNumeric>
                                            <RadzenLabel Visible=quarterCheck Text="Chọn năm" For="year" />
                                            <RadzenNumeric onkeydown="return false" Visible=yearCheck @bind-Value="@yearValue" Class="w-25" Max="DateTime.Today.Year" Name="year" TValue="int" Change="YearChange"></RadzenNumeric>
                                            <RadzenLabel Visible=yearCheck Text="Chọn năm" For="year" />
                                        </RadzenCard>
                                            @if (yearCheck == true)
                                            {
                                                List<ValueOfYear> valueYears = new List<ValueOfYear>();
                                                var valueYearList = valueOfYears.Where(vom => vom.year == yearValue).ToList();
                                                valueYears.AddRange(valueYearList);
                                                if(valueYears.Count > 0)
                                                {
                                                    <RadzenChart>
                                                        <RadzenLineSeries Smooth="@smooth" Data="@valueYears" CategoryProperty="date" Title="@valueYears.First().year.ToString()" ValueProperty="value">
                                                            <RadzenMarkers MarkerType="MarkerType.Circle" />
                                                            <RadzenSeriesDataLabels Visible="@showDataLabels" />
                                                        </RadzenLineSeries>
                                                        <RadzenCategoryAxis Padding="20" Formatter="@FormatAsMonth" />
                                                        <RadzenValueAxis Formatter="@FormatAsVND">
                                                            <RadzenGridLines Visible="true" />
                                                            <RadzenAxisTitle Text="Doanh thu" />
                                                        </RadzenValueAxis>
                                                    </RadzenChart>
                                                }
                                            } 
                                            else if (monthCheck == true)
                                            {
                                                List<ValueOfMonth> valueMonths = new List<ValueOfMonth>();
                                                var valueYearList = valueOfMonths.Where(vom => vom.year == yearValue && vom.month == monthValue).ToList();
                                                valueMonths.AddRange(valueYearList);
                                                if(valueMonths.Count > 0)
                                                {
                                                    <RadzenChart>
                                                        <RadzenLineSeries Smooth="@smooth" Data="@valueMonths" CategoryProperty="date" Title="@("Tháng "+valueMonths.First().month.ToString())" ValueProperty="value">
                                                            <RadzenMarkers MarkerType="MarkerType.Circle" />
                                                            <RadzenSeriesDataLabels Visible="@showDataLabels" />
                                                        </RadzenLineSeries>
                                                        <RadzenCategoryAxis Padding="20" Formatter="@FormatAsDay" />
                                                        <RadzenValueAxis Formatter="@FormatAsVND">
                                                            <RadzenGridLines Visible="true" />
                                                            <RadzenAxisTitle Text="Doanh thu" />
                                                        </RadzenValueAxis>
                                                    </RadzenChart>
                                                }
                                            }
                                            else if (quarterCheck == true)
                                            {
                                                List<ValueOfYear> valueYears = new List<ValueOfYear>();
                                                List<ValueOfQuarter> valueOfQuarters = new List<ValueOfQuarter>();
                                                var valueYearList = valueOfYears.Where(vom => vom.year == yearValue).ToList();
                                                foreach (var item in valueYearList)
                                                {
                                                    if(item.month >= 1 && item.month <= 3 )
                                                    {
                                                        var valueOfQuater = new ValueOfQuarter();
                                                        valueOfQuater.date = item.year +"-1-01";
                                                        valueOfQuater.quarter = 1;
                                                        valueOfQuater.year = item.year;
                                                        valueOfQuater.value = item.value;

                                                        if(valueOfQuarters.Select(voq=>voq.date).Contains(valueOfQuater.date))
                                                        {
                                                            var quarterTemp = valueOfQuarters.First(voq=>voq.date == valueOfQuater.date);
                                                            valueOfQuarters.Remove(quarterTemp);
                                                            quarterTemp.value += valueOfQuater.value;
                                                            valueOfQuarters.Add(quarterTemp);
                                                        }
                                                        else
                                                            valueOfQuarters.Add(valueOfQuater);
                                                    }
                                                    else if(item.month >= 4  && item.month <=  6)
                                                    {
                                                        var valueOfQuater = new ValueOfQuarter();
                                                        valueOfQuater.date = item.year +"-2-01";
                                                        valueOfQuater.quarter = 2;
                                                        valueOfQuater.year = item.year;
                                                        valueOfQuater.value = item.value;

                                                        if(valueOfQuarters.Select(voq=>voq.date).Contains(valueOfQuater.date))
                                                        {
                                                            var quarterTemp = valueOfQuarters.First(voq=>voq.date == valueOfQuater.date);
                                                            valueOfQuarters.Remove(quarterTemp);
                                                            quarterTemp.value += valueOfQuater.value;
                                                            valueOfQuarters.Add(quarterTemp);
                                                        }
                                                        else
                                                            valueOfQuarters.Add(valueOfQuater);
                                                    }
                                                    else if(item.month >= 7  && item.month <=  9)
                                                    {
                                                        var valueOfQuater = new ValueOfQuarter();
                                                        valueOfQuater.date = item.year +"-3-01";
                                                        valueOfQuater.quarter = 3;
                                                        valueOfQuater.year = item.year;
                                                        valueOfQuater.value = item.value;

                                                        if(valueOfQuarters.Select(voq=>voq.date).Contains(valueOfQuater.date))
                                                        {
                                                            var quarterTemp = valueOfQuarters.First(voq=>voq.date == valueOfQuater.date);
                                                            valueOfQuarters.Remove(quarterTemp);
                                                            quarterTemp.value += valueOfQuater.value;
                                                            valueOfQuarters.Add(quarterTemp);
                                                        }
                                                        else
                                                            valueOfQuarters.Add(valueOfQuater);
                                                    }
                                                    else
                                                    {
                                                        var valueOfQuater = new ValueOfQuarter();
                                                        valueOfQuater.date = item.year +"-4-01";
                                                        valueOfQuater.quarter = 4;
                                                        valueOfQuater.year = item.year;
                                                        valueOfQuater.value = item.value;

                                                        if(valueOfQuarters.Select(voq=>voq.date).Contains(valueOfQuater.date))
                                                        {
                                                            var quarterTemp = valueOfQuarters.First(voq=>voq.date == valueOfQuater.date);
                                                            valueOfQuarters.Remove(quarterTemp);
                                                            quarterTemp.value += valueOfQuater.value;
                                                            valueOfQuarters.Add(quarterTemp);
                                                        }
                                                        else
                                                            valueOfQuarters.Add(valueOfQuater);
                                                    }
                                                        
                                                }
                                                valueOfQuarters = valueOfQuarters.OrderBy(voq=>voq.quarter).ToList();
                                                if(valueOfQuarters.Count > 0)
                                                {
                                                    <RadzenChart>
                                                        <RadzenLineSeries Smooth="@smooth" Data="@valueOfQuarters" CategoryProperty="date" Title="@valueOfQuarters.First().year.ToString()" ValueProperty="value">
                                                            <RadzenMarkers MarkerType="MarkerType.Circle" />
                                                            <RadzenSeriesDataLabels Visible="@showDataLabels" />
                                                        </RadzenLineSeries>
                                                        <RadzenCategoryAxis Padding="20" Formatter="@FormatAsQuarter" />
                                                        <RadzenValueAxis Formatter="@FormatAsVND">
                                                            <RadzenGridLines Visible="true" />
                                                            <RadzenAxisTitle Text="Doanh thu" />
                                                        </RadzenValueAxis>
                                                    </RadzenChart>
                                                }
                                            }
                                            else if(valueOfYears.Count > 0)
                                            {
                                                <RadzenChart>
                                                    @for (var i = 19; i <= 22; i++)
                                                    {
                                                        List<ValueOfYear> valueYearsTemp = new List<ValueOfYear>();
                                                        List<ValueOfYear> valueYears = new List<ValueOfYear>();
                                                        var valueYearList = valueOfYears.Where(vom => vom.year.ToString() == "20"+i).ToList();
                                                        valueYearsTemp.AddRange(valueYearList);
                                                        foreach(var item in valueYearsTemp)
                                                        {
                                                            item.date = FormatYear(item.date);
                                                            valueYears.Add(item);
                                                        }
                                                        if(valueYears.Count > 0 && i == 22)
                                                        {
                                                            <RadzenLineSeries Smooth="@smooth" Data="@valueYears" CategoryProperty="date" Title="@valueYears.First().year.ToString()" ValueProperty="value">
                                                                <RadzenMarkers MarkerType="MarkerType.Circle" />
                                                                <RadzenSeriesDataLabels Visible="@showDataLabels" />
                                                            </RadzenLineSeries>
                                                        }
                                                        else if(valueYears.Count > 0)
                                                        {
                                                            <RadzenLineSeries Smooth="@smooth" Data="@valueYears" CategoryProperty="date" LineType="LineType.Dashed" Title="@valueYears.First().year.ToString()" ValueProperty="value">
                                                                <RadzenMarkers MarkerType="MarkerType.Circle" />
                                                                <RadzenSeriesDataLabels Visible="@showDataLabels" />
                                                            </RadzenLineSeries>
                                                        }
                                                    
                                                    }
                                                    <RadzenCategoryAxis Padding="30" Formatter="@FormatAsMonthYear" />
                                                    <RadzenValueAxis Formatter="@FormatAsVND">
                                                        <RadzenGridLines Visible="true" />
                                                        <RadzenAxisTitle Text="Doanh thu" />
                                                    </RadzenValueAxis>
                                                </RadzenChart>
                                            }
                                        
                                    </div>
                                </div>
                            </div>
                        </RadzenCard>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="copyright">
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
@code {
    //Check thống kê theo
    bool monthCheck = false;
    bool quarterCheck = false;
    bool yearCheck = false;

    //Lưu các giá trị cần thống kê Doanh thu
    int monthValue = 1;
    int quarterValue = 1;
    int yearValue = DateTime.Today.Year;

    // Giá trị thống kê đặt phòng
    int monthRoomValue = 1;
    int yearRoomValue = DateTime.Today.Year;

    bool smooth = true;
    bool showDataLabels = false;
    string phone = string.Empty;
    User admin = new User();
    List<User> users = new List<User>();
    List<Hotel> hotels = new List<Hotel>();
    List<Orderroom> orderroomCarts = new List<Orderroom>();
    List<Orderroom> orderroomReceipts = new List<Orderroom>();
    List<Orderroom> orderrooms = new List<Orderroom>();
    List<Businessregistration> businessregistrations = new List<Businessregistration>();

    UserService userService = new UserService();
    HotelService hotelService = new HotelService();
    OrderroomService orderroomService = new OrderroomService();
    BusinessregistrationService businessregistrationService = new BusinessregistrationService();

    class DataItem
    {
        public int Month { get; set; }
        public int Year { get; set; }
        public double Value { get; set; }
        public string StrName { get; set; }
    }

    async void YearRoomChange()
    {
        dataItems.Clear();
        var orderroom = await orderroomService.GetAllOrderrom();
        orderroom = orderroom.Where(od => od.OrderroomStatus == "2"
        && od.OrderroomDatestart.Value.Year == yearRoomValue).ToList();
        foreach (var item in orderroom)
        {
            DataItem dataItem = new DataItem();
            dataItem.Month = item.OrderroomDatestart.Value.Month;
            dataItem.Year = item.OrderroomDatestart.Value.Year;
            dataItem.Value = item.Orderroomdetails.Count;
            dataItem.StrName = $"Tháng {dataItem.Month}-{dataItem.Year}";
            if(dataItems.Any(dis=>dis.Month == dataItem.Month && dis.Year == dataItem.Year)){
                var temp = dataItems.FirstOrDefault(dis => dis.Month == dataItem.Month && dis.Year == dataItem.Year);
                temp.Value += dataItem.Value;
                var tempp = temp;
                dataItems.Remove(temp);
                dataItems.Add(tempp);
            }
            else
            {
                dataItems.Add(dataItem);
            }
        }
        StateHasChanged();
    }

    List<DataItem> dataItems = new List<DataItem>();

    protected override async Task OnInitializedAsync()
    {
        users = await userService.GetAllUser();
        hotels = await hotelService.GetAllHotel();
        orderrooms = await orderroomService.GetAllOrderrom();
        businessregistrations = await businessregistrationService.GetAllBusinessregistration();
        foreach (var item in orderrooms)
        {
            if (item.OrderroomStatus == "3")
                orderroomCarts.Add(item);
            else
                orderroomReceipts.Add(item);
        }
        InitAllList();
        foreach (var item in businessregistrations)
        {
            if(valueOfYears.Select(vom => vom.year).Contains(item.BrDate.Value.Year))
            {
                var ValueOfYear = valueOfYears.First(vom => vom.month == item.BrDate.Value.Month && vom.year == item.BrDate.Value.Year);
                valueOfYears.Remove(ValueOfYear);
                ValueOfYear.value += (double)item.Pricelistbr.PricelistbrPrice;
                valueOfYears.Add(ValueOfYear);
            }
        }
        valueOfYears = valueOfYears.OrderBy(vom=>vom.year).ThenBy(vom => vom.month).ToList();

        //Thống kê tần suất đặt phòng
        dataItems.Clear();
        var orderroom = await orderroomService.GetAllOrderrom();
        orderroom = orderroom.Where(od => od.OrderroomStatus == "2"
        && od.OrderroomDatestart.Value.Year == yearRoomValue).ToList();
        foreach (var item in orderroom)
        {
            DataItem dataItem = new DataItem();
            dataItem.Month = item.OrderroomDatestart.Value.Month;
            dataItem.Year = item.OrderroomDatestart.Value.Year;
            dataItem.Value = item.Orderroomdetails.Count;
            dataItem.StrName = $"Tháng {dataItem.Month}-{dataItem.Year}";
            if(dataItems.Any(dis=>dis.Month == dataItem.Month && dis.Year == dataItem.Year)){
                var temp = dataItems.FirstOrDefault(dis => dis.Month == dataItem.Month && dis.Year == dataItem.Year);
                temp.Value += dataItem.Value;
                var tempp = temp;
                dataItems.Remove(temp);
                dataItems.Add(tempp);
            }
            else
            {
                dataItems.Add(dataItem);
            }
        }
        StateHasChanged();
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            phone = await sessionStorage.GetItemAsync<string>("admin_phone");
            if(phone != null)
                admin = await userService.GetUser(phone);
            StateHasChanged();
        }
    }

    protected async void ExportStatistic()
    {
        var excelBytes = ExportStatisticToExcel();
        var fileName = "Thống kê danh thu";
        if(excelBytes != null)
        {
            await JS.InvokeVoidAsync("saveAsFile", $"{fileName}_{DateTime.Now.ToString("yyyyMMdd_HHmmss")}.xlsx", Convert.ToBase64String(excelBytes));
        }
    }
    public byte[] ExportStatisticToExcel()
    {
        if(monthCheck)
        {
            var stream = new MemoryStream();
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
            // ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
            using (var package = new ExcelPackage(stream))
            {
                var workSheet = package.Workbook.Worksheets.Add("Sheet1");

                // mutual
                workSheet.Row(1).Height = 20;
                workSheet.Row(1).Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                workSheet.Row(1).Style.Font.Bold = true;
                workSheet.Cells[1, 1].Value = "Ngày";
                workSheet.Cells[1, 2].Value = "Tháng";
                workSheet.Cells[1, 3].Value = "Năm";
                workSheet.Cells[1, 4].Value = "Giá trị";
                int recordIndex = 2;
                foreach (var item in valueOfMonths)
                {
                    if(item.month == monthValue && item.year == yearValue)
                    {
                        workSheet.Cells[recordIndex, 1].Value = item.day;
                        workSheet.Cells[recordIndex, 2].Value = item.month;
                        workSheet.Cells[recordIndex, 3].Value = item.year;
                        workSheet.Cells[recordIndex, 4].Value = item.value;
                        recordIndex++;
                    }
                }

                return package.GetAsByteArray();
            }
        }
        else if (quarterCheck)
        {
            var stream = new MemoryStream();
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
            // ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
            using (var package = new ExcelPackage(stream))
            {
                var workSheet = package.Workbook.Worksheets.Add("Sheet1");

                // mutual
                workSheet.Row(1).Height = 20;
                workSheet.Row(1).Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                workSheet.Row(1).Style.Font.Bold = true;
                workSheet.Cells[1, 1].Value = "Quý";
                workSheet.Cells[1, 2].Value = "Năm";
                workSheet.Cells[1, 3].Value = "Giá trị";
                int recordIndex = 2;
                Dictionary<int, double> keyValuePairValueQuaters = new Dictionary<int, double>();
                foreach (var item in valueOfYears)
                {
                    int quater = 0;
                    if(item.month <= 3)
                    {
                        quater = 1;
                        if(keyValuePairValueQuaters.Count == 0)
                        {
                            keyValuePairValueQuaters[quater] = item.value;
                        }
                        else{
                            if(!keyValuePairValueQuaters.ContainsKey(quater))
                            {
                                keyValuePairValueQuaters[quater] = item.value;
                            }
                            else
                            {
                                keyValuePairValueQuaters[quater] += item.value;
                            }
                        }
                    }
                    else if(item.month > 3 && item.month <= 6)
                    {
                        quater = 2;
                        if(keyValuePairValueQuaters.Count == 0)
                        {
                            keyValuePairValueQuaters[quater] = item.value;
                        }
                        else{
                            if(!keyValuePairValueQuaters.ContainsKey(quater))
                            {
                                keyValuePairValueQuaters[quater] = item.value;
                            }
                            else
                            {
                                keyValuePairValueQuaters[quater] += item.value;
                            }
                        }
                    }
                    else if(item.month > 6 && item.month <= 9)
                    {
                        quater = 3;
                        if(keyValuePairValueQuaters.Count == 0)
                        {
                            keyValuePairValueQuaters[quater] = item.value;
                        }
                        else{
                            if(!keyValuePairValueQuaters.ContainsKey(quater))
                            {
                                keyValuePairValueQuaters[quater] = item.value;
                            }
                            else
                            {
                                keyValuePairValueQuaters[quater] += item.value;
                            }
                        }
                    }
                    else
                    {
                        quater = 4;
                        if(keyValuePairValueQuaters.Count == 0)
                        {
                            keyValuePairValueQuaters[quater] = item.value;
                        }
                        else{
                            if(!keyValuePairValueQuaters.ContainsKey(quater))
                            {
                                keyValuePairValueQuaters[quater] = item.value;
                            }
                            else
                            {
                                keyValuePairValueQuaters[quater] += item.value;
                            }
                        }
                    }
                }
                foreach (var item in keyValuePairValueQuaters)
                {
                    workSheet.Cells[recordIndex, 1].Value = item.Key;
                    workSheet.Cells[recordIndex, 2].Value = item.Value;
                    recordIndex++;
                }
                return package.GetAsByteArray();
            }
        }
        else if (yearCheck)
        {
            var stream = new MemoryStream();
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
            // ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
            using (var package = new ExcelPackage(stream))
            {
                var workSheet = package.Workbook.Worksheets.Add("Sheet1");

                // mutual
                workSheet.Row(1).Height = 20;
                workSheet.Row(1).Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                workSheet.Row(1).Style.Font.Bold = true;
                workSheet.Cells[1, 1].Value = "Tháng";
                workSheet.Cells[1, 2].Value = "Năm";
                workSheet.Cells[1, 3].Value = "Giá trị";
                int recordIndex = 2;
                foreach (var item in valueOfYears)
                {
                    if(item.year == yearValue)
                    {
                        workSheet.Cells[recordIndex, 1].Value = item.month;
                        workSheet.Cells[recordIndex, 2].Value = item.year;
                        workSheet.Cells[recordIndex, 3].Value = item.value;
                        recordIndex++;
                    }
                }

                return package.GetAsByteArray();
            }
        }
        else
        {
            var stream = new MemoryStream();
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
            // ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
            using (var package = new ExcelPackage(stream))
            {
                var workSheet = package.Workbook.Worksheets.Add("Sheet1");

                // mutual
                workSheet.Row(1).Height = 20;
                workSheet.Row(1).Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                workSheet.Row(1).Style.Font.Bold = true;
                workSheet.Cells[1, 1].Value = "Năm";
                workSheet.Cells[1, 2].Value = "Giá trị";
                int recordIndex = 2;
                Dictionary<int, double> keyValuePairValueYears = new Dictionary<int, double>();
                foreach (var item in valueOfYears)
                {
                    if(keyValuePairValueYears.Count == 0)
                    {
                        keyValuePairValueYears[item.year] = item.value;
                    }
                    else{
                        if(!keyValuePairValueYears.ContainsKey(item.year))
                        {
                            keyValuePairValueYears[item.year] = item.value;
                        }
                        else
                        {
                            keyValuePairValueYears[item.year] += item.value;
                        }
                    }
                }
                foreach (var item in keyValuePairValueYears)
                {
                    workSheet.Cells[recordIndex, 1].Value = item.Key;
                    workSheet.Cells[recordIndex, 2].Value = item.Value;
                    recordIndex++;
                }
                keyValuePairValueYears.Clear();
                return package.GetAsByteArray();
            }
        }
        return null;
    }

    void MonthChange()
    {
        valueOfMonths.Clear();
        InitAllList();
        //Thống kê theo tháng
        foreach (var item in businessregistrations)
        {
            if(valueOfMonths.Select(vom=>vom.month).Contains(item.BrDate.Value.Month) && valueOfMonths.Select(vom => vom.year).Contains(item.BrDate.Value.Year))
            {
                var ValueOfMonth = valueOfMonths.Where(vom => vom.month == item.BrDate.Value.Month && vom.year == item.BrDate.Value.Year && vom.day == item.BrDate.Value.Day).ToList();
                if(ValueOfMonth.Count > 0)
                {
                    foreach (var valueOfMonth in ValueOfMonth)
                    {
                        if (valueOfMonths.Contains(valueOfMonth))
                        {
                            var valueOfMonthTemp = valueOfMonth;
                            valueOfMonths.Remove(valueOfMonth);
                            valueOfMonthTemp.value += (double)item.Pricelistbr.PricelistbrPrice;
                            valueOfMonths.Add(valueOfMonthTemp);
                        }
                        else{
                            var valueOfMonthTemp = valueOfMonth;
                            valueOfMonths.Remove(valueOfMonth);
                            valueOfMonthTemp.value = (double)item.Pricelistbr.PricelistbrPrice;
                            valueOfMonths.Add(valueOfMonthTemp);
                        }
                    }
                }
            }
        }
        valueOfMonths = valueOfMonths.OrderBy(vom=>vom.month).ThenBy(vom => vom.day).ToList();
        StateHasChanged();
    }
    void QuarterChange()
    {
        //YearChange();
    }
    void YearChange()
    {
        valueOfYears.Clear();
        InitAllList();
        foreach (var item in businessregistrations)
        {
            if(valueOfYears.Select(vom=>vom.month).Contains(item.BrDate.Value.Month) && valueOfYears.Select(vom => vom.year).Contains(item.BrDate.Value.Year))
            {
                var ValueOfYear = valueOfYears.First(vom => vom.month == item.BrDate.Value.Month && vom.year == item.BrDate.Value.Year);
                valueOfYears.Remove(ValueOfYear);
                ValueOfYear.value += (double)item.Pricelistbr.PricelistbrPrice;
                valueOfYears.Add(ValueOfYear);
            }
        }
        valueOfYears = valueOfYears.OrderBy(vom=>vom.year).ThenBy(vom => vom.month).ToList();
    }
    void OnChange(object value)
    {
        if (value != null)
            if (value.ToString() == "0")
            {
                monthCheck = false;
                yearCheck = false;
                quarterCheck = false;
            }
            else if (value.ToString() == "1")
            {
                monthCheck = true;
                yearCheck = false;
                quarterCheck = false;
            }
            else if (value.ToString() == "2")
            {
                quarterCheck = true;
                yearCheck = false;
                monthCheck = false;
            }
            else
            {
                yearCheck = true;
                monthCheck = false;
                quarterCheck = false;
            }

    }
    //Tính doanh thu của tháng
    class ValueOfYear
    {
        public int month{ get; set; }
        public int year{ get; set; }
        public double value{ get; set; }
        public string date{ get; set; }
    }
    List<ValueOfYear> valueOfYears = new List<ValueOfYear>();
    class ValueOfQuarter
    {
        public int quarter{ get; set; }
        public int year{ get; set; }
        public double value{ get; set; }
        public string date{ get; set; }
    }
    List<ValueOfQuarter> valueOfQuarters = new List<ValueOfQuarter>();
    class ValueOfMonth
    {
        public int day{ get; set; }
        public int month{ get; set; }
        public int year{ get; set; }
        public double value{ get; set; }
        public string date{ get; set; }
    }
    List<ValueOfMonth> valueOfMonths = new List<ValueOfMonth>();
    class Choose
    {
        public string name{ get; set; }
        public int value{ get; set; }
    }
    List<Choose> chooses = new List<Choose>()
    {
        new Choose
        {
            name = "Thống kê theo tháng",
            value = 1
        },
        new Choose
        {
            name = "Thống kê theo quý",
            value = 2
        },
        new Choose
        {
            name = "Thống kê theo năm",
            value = 3
        }
    };

    string FormatAsVND(object value)
    {
        return ((double)value).ToString("C0", CultureInfo.CreateSpecificCulture("vi-VN"));
    }

    string FormatAsMonth(object value)
    {
        if (value != null)
        {
            return Convert.ToDateTime(value).ToString("TMM", CultureInfo.CreateSpecificCulture("vi-VN"));
        }

        return string.Empty;
    }
    string FormatAsMonthYear(object value)
    {
        if (value != null)
        {
            string yearTemp = "2022";
            string[] stringsplit = value.ToString().Split("-");
            string stringRes = yearTemp + "-" + stringsplit[1] + "-" + stringsplit[2];
            return Convert.ToDateTime(stringRes).ToString("TMM", CultureInfo.CreateSpecificCulture("vi-VN"));
        }

        return string.Empty;
    }
    string FormatYear(object value)
    {
        if (value != null)
        {
            string yearTemp = "2022";
            string[] stringsplit = value.ToString().Split("-");
            string stringRes = yearTemp + "-" + stringsplit[1] + "-" + stringsplit[2];
            return stringRes;
        }

        return string.Empty;
    }
    string FormatAsQuarter(object value)
    {
        if (value != null)
        {
            return Convert.ToDateTime(value).ToString("QMM", CultureInfo.CreateSpecificCulture("vi-VN"));
        }

        return string.Empty;
    }
    string FormatAsDay(object value)
    {
        if (value != null)
        {
            var res =  Convert.ToDateTime(value).ToString("dd", CultureInfo.CreateSpecificCulture("vi-VN"));
            return res;
        }

        return string.Empty;
    }
    protected void InitAllList()
    {
        for (var i = 2018; i <= DateTime.Today.Year; i++){
            for (var j = 1; j < 13; j++)
            {
                var tempYear = new ValueOfYear();
                tempYear.month = j;
                tempYear.year = i;
                tempYear.value = 0;
                tempYear.date = i + "-" + j + "-01";
                valueOfYears.Add(tempYear);
            }
        }
        for (var i = 2018; i <= DateTime.Today.Year; i++){
            for (var k = 1; k < 5; k++)
            {
                var tempQuarter = new ValueOfQuarter();
                tempQuarter.quarter = k;
                tempQuarter.year = i;
                tempQuarter.value = 0;
                tempQuarter.date = i + "-" + k + "-01";
                valueOfQuarters.Add(tempQuarter);
            }
        }
        for (var i = 2018; i <= DateTime.Today.Year; i++){
            for (var j = 1; j < 13; j++)
            {
                List<int> dayTemp;
                if (j == 1 || j == 3 || j == 5 || j == 7 || j == 8 || j == 10 || j == 12)
                    dayTemp = new List<int> { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31 };
                else if(j == 4 || j == 6 || j == 9 || j == 11)
                    dayTemp = new List<int> { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 };
                else
                {
                    if(i % 400 == 0)
                        dayTemp = new List<int> { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29};
                    else
                        dayTemp = new List<int> { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28 };
                }
                foreach (var item in dayTemp)
                {
                    try{
                        var tempMonth = new ValueOfMonth();
                        tempMonth.month = j;
                        tempMonth.year = i;
                        tempMonth.value = 0;
                        var temp = i + "-" + j + "-" + item;
                        tempMonth.date = temp;
                        tempMonth.day = item;
                        valueOfMonths.Add(tempMonth);
                    }catch(Exception ex){
                        Console.Write(ex.ToString());
                    }
                }
            }
        }
    }
}